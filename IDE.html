<!DOCTYPE html>
<html>
	<head>
		<script src="Interpreter.js"></script>
		<script>
			const xres = 16;
			const yres = 15;
			let canvas = 0;
			let ctx = 0;
			let imageData = 0;
			let interpreter = 0;
			let compiler = new Compiler();

			function loop()
			{
				if(interpreter)
					for(let i = 0; i < 1024; i++)
						interpreter.execute();
				//draw frame
				show();
				ctx.putImageData(imageData, 0, 0);
				requestAnimationFrame(loop);
			}

			function show()
			{
				if(!interpreter) return;
				for(let i = 0; i < xres * yres * 4; i++)
					imageData.data[i] = (i & 3) == 3 ? 255 : interpreter.mem.gfx[i >> 2] >> (8 * (i & 3)) & 0xff;
			}

			function init()
			{
				const textarea = document.querySelector('textarea');
				const code = restoreCode();
				if(code)
					textarea.value = code;
				textarea.onkeydown = function(e)
				{
					if(e.keyCode==9 || e.which==9)
					{
						e.preventDefault();
						var s = this.selectionStart;
						this.value = this.value.substring(0,this.selectionStart) + "\t" + this.value.substring(this.selectionEnd);
						this.selectionEnd = s+1; 
					}
				}
				canvas = document.querySelector("canvas");
				canvas.width = xres;
				canvas.height = yres;
				ctx = canvas.getContext("2d")
				imageData = ctx.getImageData(0, 0, xres, yres);
				requestAnimationFrame(loop);
			}

			function run()
			{
				const code = compiler.compile(document.querySelector("textarea").value, console);
				console.log(compiler.decompile(code));
				interpreter = new Interpreter(code, new MemoryMap());
			}

			function halt()
			{
				interpreter = 0;
			}

			function storeCode(code)
			{
				localStorage.setItem("code", code);
			}
			function restoreCode()
			{
				return localStorage.getItem("code");
			}

		</script>
		<style>
			body
			{
				background-color: #222;
			}
			canvas
			{
				image-rendering: pixelated;
				zoom: 16.0;
				border-style: solid;
				border-color: #ff1493;
				border-width: 0.1px;
				background-color: black;
			}
			textarea
			{
				background-color: #111;
				border-color: #ff1493;
				border-width: 2px;
				border-style: solid;
				color: #ddd;
				overflow-x: auto;
				text-wrap: nowrap;
				tab-size: 4;
			}
			td
			{
				vertical-align: top;
			}
		</style>
	</head>
	<body onload="init()">
		<table>
			<tr>
					<td rowspan="2"><textarea id="code" cols="80" rows="48" oninput="storeCode(this.value)">
	push	0xa000		//store frame buffer address in mem[0]
	push 	0x0000		
	stor
	push	15			//pushes 15 on stack (pixel rows)
y:
	push 	16			//pushed 16 on stack (pixel cols)
x:
	push 	0x0004		//load rgb value from mem[4]		
	load
	push	0x0000		//load frame buffer address from mem[0]
	load
	stor				//write pixel
	push	0x0000		//increment frame buffer address in mem[0]
	load
	inc
	push	0x0000
	stor
	push	0x0004		//add 0x10 to rgb color in mem[4]
	load
	push	0x10
	add
	push	0x0004
	stor
	dec					//decrement x counter on top of stack
	clone				//clone x counter for comparison
	push	x			//pushes address of label x
	jnz					//pops label address and jumps to label if value on top of stack is != 0
	pop					//remove x counter
	push	0x0004		//add 0x010000 to rgb color in mem[4]
	load
	push	0x100000
	add
	push	0x0004
	stor
	dec					//decrement y counter on top of stack
	clone				//clone y counter for comparison
	push	y			//pushes address of label y
	jnz					//pops label address and jumps to label if value on top of stack is != 0
	pop					//pop clear y counter
					</textarea></td>
					<td><canvas width="16" height="15"></canvas>
					<br><button>L</button><button>R</button><button>U</button><button>D</button><button>B</button><button>A</button>
					<br>
					<br><button onclick="run()">RUN</button><button onclick="halt()">HALT</button><button>UPLOAD</button>
				</td>
			</tr>
			<tr>
				<td><td>
			</tr>
		</table>
	</body>
</html>